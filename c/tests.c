#include "cipher.h"
#include "tools.h"
#include <stdio.h>
#include <stdlib.h>
#include <string.h>

void testByteXor(void) {
    byte a[] = {0x0F, 0x1A, 0x2B, 0x3C};
    byte b[] = {0x0F, 0x1B, 0x2B, 0x3D};
    byte expected[] = {0x00, 0x01, 0x00, 0x01}; // résultat de a XOR b

    byteXor(a, b, 4);

    for (int i = 0; i < 4; i++) {
        if (a[i] != expected[i]) {
            printf("byteXor: FAILED\n");
            return;
        }
    }
    printf("byteXor: OK\n");
}

void testMulti(void) {
    byte a = 0x57;
    byte b = 0x83;
    byte expected = 0xc1; // résultat de a * b

    byte res = multi(a, b);

    if (res != expected) {
        printf("multi: FAILED\n");
        return;
    }
    printf("multi: OK\n");
}

void testSwitchColRows(void) {
    byte state[] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07 ,0x08, 0x09, 0x0a, 0x0b ,0x0c, 0x0d, 0x0e, 0x0f};
    byte expected[] = {0x00, 0x04, 0x08, 0x0c ,0x01, 0x05, 0x09, 0x0d ,0x02, 0x06, 0x0a, 0x0e ,0x03, 0x07, 0x0b, 0x0f};

    switchColRows(state);

    for (int i = 0; i < 16; i++) {
        if (state[i] != expected[i]) {
            printf("switchColRows: FAILED\n");
            return;
        }
    }
    printf("switchColRows: OK\n");
}

void testSplitArr(void) {
    byte input[] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07 ,0x08, 0x09, 0x0a, 0x0b ,0x0c, 0x0d, 0x0e, 0x0f};
    byte expected1[] = {0x00, 0x01, 0x02, 0x03};
    byte expected2[] = {0x04, 0x05, 0x06, 0x07};
    byte out1[4] = {0};
    byte out2[4] = {0};

    splitArr(input, out1, 0, 4);
    splitArr(input, out2, 4, 8);

    for (int i = 0; i < 4; i++) {
        if (out1[i] != expected1[i]) {
            printf("splitArr: FAILED\n");
            return;
        }
    }

    for (int i = 0; i < 4; i++) {
        if (out2[i] != expected2[i]) {
            printf("splitArr: FAILED\n");
            return;
        }
    }

    printf("splitArr: OK\n");
}

void testMergeArr(void) {
    byte base[8] = {0x00, 0x01, 0x02, 0x03};
    byte input[] = {0x04, 0x05, 0x06, 0x07};
    byte expected[] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07};

    mergeArr(input, base, 4, 8);

    for (int i = 0; i < 8; i++) {
        if (base[i] != expected[i]) {
            printf("mergeArr: FAILED\n");
            return;
        }
    }
    printf("mergeArr: OK\n");
}

int main (void){
    printf("----- Test des outils -----\n");
    testByteXor();
    testMulti();
    testSwitchColRows();
    testSplitArr();
    testMergeArr();

    
	byte in1[16] = {0x00, 0x11, 0x22, 0x33 ,0x44, 0x55, 0x66, 0x77 ,0x88, 0x99, 0xaa, 0xbb ,0xcc, 0xdd, 0xee, 0xff};
	byte in2[16] = {0x00, 0x11, 0x22, 0x33 ,0x44, 0x55, 0x66, 0x77 ,0x88, 0x99, 0xaa, 0xbb ,0xcc, 0xdd, 0xee, 0xff};
	byte in3[16] = {0x00, 0x11, 0x22, 0x33 ,0x44, 0x55, 0x66, 0x77 ,0x88, 0x99, 0xaa, 0xbb ,0xcc, 0xdd, 0xee, 0xff};

	byte key128[16] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07 ,0x08, 0x09, 0x0a, 0x0b ,0x0c, 0x0d, 0x0e, 0x0f};
	byte key192[24] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07 ,0x08, 0x09, 0x0a, 0x0b ,0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 
					0x12, 0x13 ,0x14, 0x15, 0x16, 0x17};
	byte key256[32] = {0x00, 0x01, 0x02, 0x03 ,0x04, 0x05, 0x06, 0x07 ,0x08, 0x09, 0x0a, 0x0b ,0x0c, 0x0d, 0x0e, 0x0f, 0x10, 0x11, 
					0x12, 0x13 ,0x14, 0x15, 0x16, 0x17, 0x18, 0x19 ,0x1a, 0x1b, 0x1c, 0x1d, 0x1e, 0x1f};
	
	byte w1[176] = {0};
	byte w2[208] = {0};
	byte w3[240] = {0};

	keyExpansion(key128, w1, 4, 10);
	keyExpansion(key192, w2, 6, 12);
	keyExpansion(key256, w3, 8, 14);

	printByte(in1, 16);
	cipher(in1, w1, 10);
	printByte(in1, 16);
	invCipher(in1, w1, 10);
	printByte(in1, 16);

	cipher(in2, w2, 12);
	printByte(in2, 16);
	invCipher(in2, w2, 12);
	printByte(in2, 16);

	cipher(in3, w3, 14);
	printByte(in3, 16);
	invCipher(in3, w3, 14);
	printByte(in3, 16);


	return 1;
}